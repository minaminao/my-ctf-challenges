# Author's Writeup for cat3

Daily AlpacaHack で 12/24 に出題した『cat3』の作問者 Writeup です。

https://alpacahack.com/daily/challenges/cat3

## 問題概要

問題のトピックは `Jail` です。

CTF には Jail と呼ばれるカテゴリーがあり、「何かしら制限された実行環境（＝jail）から脱出する」ことをテーマとします。
その与えられた環境・制限が完全ではないことを突いて、想定外の操作を達成できればフラグが得られる、というものです。
Jail は考察要素やパズル要素があることが多いので、個人的にとても好きなカテゴリーです。

この問題では、以下の Python スクリプト `jail.py` が与えられます:

```py
# 🐈️ < gift is in ../flag.txt
import os
os.system(f"cat {input("$ cat ")[:3]}")
```

実行すると、まず `input` 関数により `$ cat ` が出力され、入力を待ち受けます。

そして、その入力を先頭から3文字分だけ `[:3]` により抽出し、 `cat (3文字)` を `os.system` 関数によりシェルで実行します。

コメントや `Dockerfile` を読めば分かる通り、各ファイルの場所について次のことがわかります:
- `jail.py` は `/jail/app/jail.py` に置かれている。
- `flag.txt` は `/jail/flag.txt` に置かれている。

## 解法

この問題のゴールは `/jail/app/jail.py` から `/jail/flag.txt` を読むことです。

まずは、3文字制限がない場合について考えてみると、次のコマンドのどれかでフラグを取得できます:

```
cat ../flag.txt
cat /jail/flag.txt
```

これを短縮すれば 3 文字以下にできるでしょうか？

シェルでは `*` のワイルドカードが使えることが思い浮かべば、それぞれ次のように短縮できます:

```
cat ../*
cat /*/*
```

というわけで、4文字までは縮められました。
が、それより小さい文字数は難しいようです（もしあれば教えて下さい）。

では、どうしたらいいでしょうか？

ここで発想を変えて、 `cat` にフラグを出力させるのではなく、新たにシェルを立ち上げられないか考えてみます。
シェルを立ち上げられれば、3文字制約がなくなり、何でもコマンドを与えることができて解けそうです。

シェルは `sh` コマンドで立ち上がります。
3文字制約があるので、

```
cat (何か1文字)sh
```

で、 `sh` を立ち上げつつフラグを読むことはできないでしょうか。

### 解法1: `cat |sh`

`cat` コマンドはファイルパスを与えなくても実行できます。
その場合 `cat` は標準入力から読み込み、それをオウム返しで出力します。
これは `man cat` でも確認できます:

> With no FILE, or when FILE is -, read standard input.

というわけで、`cat |sh` を実行すれば、ユーザーからの入力をパイプ `|` によって、そのまま `sh` に渡して実行させられます。後は `cat ../flag.txt` を実行するだけです。

```
$ nc $HOST $PORT
$ cat |sh
cat ../flag.txt
Alpaca{:fish::fish::fish:}
```

### 解法2: `cat &sh`

`&` を使えば `cat` をバックグラウンドで起動させられ、フォアグラウンドで `sh` を実行できます。
後は同様にコマンドを叩くだけです。

```
$ nc $HOST $PORT
$ cat &sh
cat ../flag.txt
Alpaca{:fish::fish::fish:}
```

以上で、フラグを取得できました。

Flag: `Alpaca{:fish::fish::fish:}`
